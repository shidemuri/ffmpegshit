<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<body>
    <div class="w-25 mx-auto mt-4 d-flex flex-column">
        <input type="file" name="swag" id="swag" accept="image/png, image/jpeg">
        <p></p>
        <label for="thr" id="thr2">Threshold: 170</label>
        <input type="range" class="form-range" name="thr" id="thr" min="0" max="255" value="170">
        <label for="size" id="size2">Size: 25%</label>
        <input type="range" class="form-range" name="size" id="size" min="1" max="100" value="25">
        <label for="size" id="prev2">Preview size: 100%</label>
        <input type="range" class="form-range" name="prev2" id="prev" min="1" max="100" value="100">
        <div class="flex-row">
            <label for="inv">Invert pixels:</label>
            <input type="checkbox" name="inv" id="inv">
        </div>
        <p></p>
        <textarea style="align-self:center; font-family: monospace;"name="owo" id="output" readonly>owo</textarea>
        <script>
            
            const ibagem = document.querySelector("#swag");
            const threshold = document.querySelector("#thr");
            const thresholdtext = document.querySelector("#thr2");
            const size = document.querySelector("#size");
            const sizetext = document.querySelector("#size2");
            const prevs = document.querySelector("#prev");
            const prevstext = document.querySelector("#prev2");
            const invert = document.querySelector("#inv")
            const output = document.querySelector("textarea");
            let file = null;
            function atualizarImagem(file){
                const reader = new FileReader();

                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const w = img.width*size.value/100;
                        const h = img.height * (w / img.width); 

                        canvas.width = w;
                        canvas.height = h;

                        ctx.drawImage(img, 0, 0, w, h);
                        gerarTexto(canvas);
                    };
                    img.src = e.target.result;
                };
                
                reader.readAsDataURL(file);
            }
            ibagem.addEventListener("input",(e)=>{
                file = e.target.files[0];
                atualizarImagem(file);
            })

            const blocks = {"⠀":[[0,0],[0,0],[0,0]],"⠁":[[1,0],[0,0],[0,0]],"⠂":[[0,0],[1,0],[0,0]],"⠃":[[1,0],[1,0],[0,0]],"⠄":[[0,0],[0,0],[1,0]],"⠅":[[1,0],[0,0],[1,0]],"⠆":[[0,0],[1,0],[1,0]],"⠇":[[1,0],[1,0],[1,0]],"⠈":[[0,1],[0,0],[0,0]],"⠉":[[1,1],[0,0],[0,0]],"⠊":[[0,1],[1,0],[0,0]],"⠋":[[1,1],[1,0],[0,0]],"⠌":[[0,1],[0,0],[1,0]],"⠍":[[1,1],[0,0],[1,0]],"⠎":[[0,1],[1,0],[1,0]],"⠏":[[1,1],[1,0],[1,0]],"⠐":[[0,0],[0,1],[0,0]],"⠑":[[1,0],[0,1],[0,0]],"⠒":[[0,0],[1,1],[0,0]],"⠓":[[1,0],[1,1],[0,0]],"⠔":[[0,0],[0,1],[1,0]],"⠕":[[1,0],[0,1],[1,0]],"⠖":[[0,0],[1,1],[1,0]],"⠗":[[1,0],[1,1],[1,0]],"⠘":[[0,1],[0,1],[0,0]],"⠙":[[1,1],[0,1],[0,0]],"⠚":[[0,1],[1,1],[0,0]],"⠛":[[1,1],[1,1],[0,0]],"⠜":[[0,1],[0,1],[1,0]],"⠝":[[1,1],[0,1],[1,0]],"⠞":[[0,1],[1,1],[1,0]],"⠟":[[1,1],[1,1],[1,0]],"⠠":[[0,0],[0,0],[0,1]],"⠡":[[1,0],[0,0],[0,1]],"⠢":[[0,0],[1,0],[0,1]],"⠣":[[1,0],[1,0],[0,1]],"⠤":[[0,0],[0,0],[1,1]],"⠥":[[1,0],[0,0],[1,1]],"⠦":[[0,0],[1,0],[1,1]],"⠧":[[1,0],[1,0],[1,1]],"⠨":[[0,1],[0,0],[0,1]],"⠩":[[1,1],[0,0],[0,1]],"⠪":[[0,1],[1,0],[0,1]],"⠫":[[1,1],[1,0],[0,1]],"⠬":[[0,1],[0,0],[1,1]],"⠭":[[1,1],[0,0],[1,1]],"⠮":[[0,1],[1,0],[1,1]],"⠯":[[1,1],[1,0],[1,1]],"⠰":[[0,0],[0,1],[0,1]],"⠱":[[1,0],[0,1],[0,1]],"⠲":[[0,0],[1,1],[0,1]],"⠳":[[1,0],[1,1],[0,1]],"⠴":[[0,0],[0,1],[1,1]],"⠵":[[1,0],[0,1],[1,1]],"⠶":[[0,0],[1,1],[1,1]],"⠷":[[1,0],[1,1],[1,1]],"⠸":[[0,1],[0,1],[0,1]],"⠹":[[1,1],[0,1],[0,1]],"⠺":[[0,1],[1,1],[0,1]],"⠻":[[1,1],[1,1],[0,1]],"⠼":[[0,1],[0,1],[1,1]],"⠽":[[1,1],[0,1],[1,1]],"⠾":[[0,1],[1,1],[1,1]],"⠿":[[1,1],[1,1],[1,1]]}

            function eq(a, b) {
                if (a === b) return true;
                if (a == null || b == null) return false;
                if (a.length !== b.length) return false;
            
                for (var i = 0; i < a.length; ++i) {
                    if (a[i] !== b[i]) return false;
                }
                return true;
            }

            function getGrayscale(data,idx){
                return Number(!(((data[idx]??0)+(data[idx+1]??0)+(data[idx+2]??0))/3<threshold.value) ^ !invert.checked)
            }

            async function gerarTexto(canvas){
                try {
                    const ctx = canvas.getContext("2d");
                    this.data = ctx.getImageData(0,0,canvas.width,canvas.height).data
                    this.width = canvas.width;
                    this.height = canvas.height;
                    let thing = "";
                    await new Promise((res,rej)=>{
                        for (let y = 0; y < this.height; y=y+3) {
                            for (let x = 0; x < this.width; x=x+2) {
                                const bleeh = [
                                    getGrayscale(this.data,(this.width * y + x) << 2),getGrayscale(this.data,this.width * y + (x+1) << 2),
                                    getGrayscale(this.data,(this.width * (y+1) + x) << 2),getGrayscale(this.data,this.width * (y+1) + (x+1) << 2),
                                    getGrayscale(this.data,(this.width * (y+2) + x) << 2),getGrayscale(this.data,this.width * (y+2) + (x+1) << 2),
                                ]
                                for(const [k,v] of Object.entries(blocks)){
                                    if(eq([...v[0],...v[1],...v[2]],bleeh)) {
                                        thing += k
                                        break;
                                    }
                                }
                            }
                            thing += '\n'
                        }
                        thing = thing.split('');
                        thing.pop();
                        thing = thing.join('');
                        res()
                    })
                    const out2 = thing.split(/\n/gm);
                    output.setAttributeNS(null,"cols",out2[0].length*1.75);
                    output.setAttributeNS(null,"rows",out2.length);
                    output.style["font-size"] = (1000/size.value)*prevs.value/100 + "px";
                    output.value = thing;
                } catch(e) {
                    output.value = e;
                };
            };
            output.addEventListener("click",()=>{
                output.select();
                navigator.clipboard.writeText(output.value);
            })
            threshold.addEventListener("input",ev=>{
                thresholdtext.innerText = "Threshold: " + threshold.value;
                if(file) atualizarImagem(file);
            });
            size.addEventListener("input",ev=>{
                sizetext.innerText = "Size: " + size.value + "%";
                if(file) atualizarImagem(file);
            });
            prevs.addEventListener("input",ev=>{
                prevstext.innerText = "Preview size: " + prevs.value + "%";
                if(file) atualizarImagem(file);
            });
            invert.addEventListener("click",()=>{
                if(file) atualizarImagem(file);
            })
        </script>
    </div>
</body>
</html>